generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// 1Ô∏è‚É£ CATEGORIES (Danh m·ª•c ƒëa c·∫•p)
// ---------------------------------------------------------
model Category {
  id        Int        @id @default(autoincrement())
  name      String
  parentId  Int?       // Cho ph√©p null n·∫øu l√† danh m·ª•c g·ªëc
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  products  Product[]

  @@map("Categories")
}

// ---------------------------------------------------------
// 2Ô∏è‚É£ BRANDS
// ---------------------------------------------------------
model Brand {
  id          Int       @id @default(autoincrement())
  name        String
  description String?   @db.Text
  logoUrl     String?
  products    Product[]

  @@map("Brands")
}

// ---------------------------------------------------------
// 3Ô∏è‚É£ PRODUCTS (S·∫£n ph·∫©m g·ªëc - Cha)
// ---------------------------------------------------------
model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  ingredients String?  @db.Text // Th√†nh ph·∫ßn
  usageGuide  String?  @db.Text // H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng
  
  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])
  
  brandId     Int
  brand       Brand    @relation(fields: [brandId], references: [id])

  variants    ProductVariant[]
  
  createdAt   DateTime @default(now())
  status      Boolean  @default(true) // Active/Inactive

  @@map("Products")
}

// ---------------------------------------------------------
// 4Ô∏è‚É£ & 5Ô∏è‚É£ ATTRIBUTES (M√†u & Size)
// ---------------------------------------------------------
model ProductColor {
  id        Int              @id @default(autoincrement())
  name      String           // Vd: ƒê·ªè Ruby, H·ªìng C√°nh Sen
  code      String           // Vd: #FF0000
  variants  ProductVariant[]

  @@map("ProductColors")
}

model ProductSize {
  id        Int              @id @default(autoincrement())
  name      String           // Vd: 50ml, 100ml
  unit      String           // Vd: ml, gram
  variants  ProductVariant[]

  @@map("ProductSizes")
}

// ---------------------------------------------------------
// ‚≠ê 6Ô∏è‚É£ PRODUCT VARIANTS (TRUNG T√ÇM)
// ---------------------------------------------------------
model ProductVariant {
  id        Int      @id @default(autoincrement())
  sku       String   @unique // M√£ qu·∫£n l√Ω kho (Vd: SRM-DO-50)
  
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  colorId   Int?     // C√≥ th·ªÉ null n·∫øu sp kh√¥ng c√≥ m√†u
  color     ProductColor? @relation(fields: [colorId], references: [id])
  
  sizeId    Int?     // C√≥ th·ªÉ null n·∫øu sp freesize
  size      ProductSize?  @relation(fields: [sizeId], references: [id])

  images      ProductImage[]
  prices      ProductPrice[]
  inventory   ProductInventory? // 1-1 relation (ho·∫∑c 1-n n·∫øu nhi·ªÅu kho)
  cartItems   CartItem[]
  orderDetails OrderDetail[]
  reviews     Review[]
  wishlists   Wishlist[]

  status    Boolean  @default(true)

  @@map("ProductVariants")
}

// ---------------------------------------------------------
// 7Ô∏è‚É£ PRODUCT IMAGES (Theo Variant)
// ---------------------------------------------------------
model ProductImage {
  id        Int            @id @default(autoincrement())
  imageUrl  String
  isPrimary Boolean        @default(false)
  
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("ProductImages")
}

// ---------------------------------------------------------
// 8Ô∏è‚É£ PRODUCT PRICES (L·ªãch s·ª≠ gi√°)
// ---------------------------------------------------------
model ProductPrice {
  id        Int            @id @default(autoincrement())
  price     Decimal        @db.Decimal(10, 2)
  startDate DateTime       @default(now())
  endDate   DateTime?      // Null = Gi√° hi·ªán t·∫°i ƒëang √°p d·ª•ng
  
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("ProductPrices")
}

// ---------------------------------------------------------
// 9Ô∏è‚É£ INVENTORIES (Kho)
// ---------------------------------------------------------
model ProductInventory {
  id               Int            @id @default(autoincrement())
  stockQuantity    Int            @default(0) // S·ªë l∆∞·ª£ng th·ª±c trong kho
  reservedQuantity Int            @default(0) // S·ªë l∆∞·ª£ng kh√°ch ƒëang gi·ªØ trong gi·ªè/ch·ªù thanh to√°n
  
  variantId        Int            @unique // M·ªói variant c√≥ 1 record kho
  variant          ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  updatedAt        DateTime       @updatedAt

  @@map("ProductInventories")
}

// ---------------------------------------------------------
// üîü USERS & 1Ô∏è‚É£1Ô∏è‚É£ ADDRESSES
// ---------------------------------------------------------
enum Role {
  CUSTOMER
  ADMIN
  STAFF
}

model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique
  passwordHash String
  fullName     String?
  email        String    @unique
  phone        String?
  role         Role      @default(CUSTOMER)
  status       Boolean   @default(true)
  createdAt    DateTime  @default(now())

  addresses    UserAddress[]
  orders       Order[]
  cart         Cart?
  reviews      Review[]
  wishlists    Wishlist[]
  voucherUsage VoucherUsage[]

  @@map("Users")
}

model UserAddress {
  id            Int     @id @default(autoincrement())
  receiverName  String
  phone         String
  addressDetail String
  isDefault     Boolean @default(false)
  
  userId        Int
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders        Order[]

  @@map("UserAddresses")
}

// ---------------------------------------------------------
// 1Ô∏è‚É£2Ô∏è‚É£ & 1Ô∏è‚É£3Ô∏è‚É£ CART (Gi·ªè h√†ng)
// ---------------------------------------------------------
model Cart {
  id        Int        @id @default(autoincrement())
  updatedAt DateTime   @updatedAt
  
  userId    Int        @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     CartItem[]

  @@map("Carts")
}

model CartItem {
  id        Int            @id @default(autoincrement())
  quantity  Int
  
  cartId    Int
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@map("CartItems")
}

// ---------------------------------------------------------
// 1Ô∏è‚É£4Ô∏è‚É£ ORDERS (ƒê∆°n h√†ng)
// ---------------------------------------------------------
enum OrderStatus {
  PENDING      // Ch·ªù x√°c nh·∫≠n
  CONFIRMED    // ƒê√£ x√°c nh·∫≠n
  SHIPPING     // ƒêang giao
  DELIVERED    // ƒê√£ giao
  CANCELLED    // ƒê√£ h·ªßy
  RETURNED     // Tr·∫£ h√†ng
}

model Order {
  id             Int             @id @default(autoincrement())
  orderDate      DateTime        @default(now())
  status         OrderStatus     @default(PENDING)
  
  subTotal       Decimal         @db.Decimal(12, 2) // T·ªïng ti·ªÅn h√†ng
  discountAmount Decimal         @default(0) @db.Decimal(12, 2) // Ti·ªÅn gi·∫£m gi√°
  shippingFee    Decimal         @default(0) @db.Decimal(12, 2) // Ph√≠ ship
  totalAmount    Decimal         @db.Decimal(12, 2) // T·ªïng thanh to√°n cu·ªëi c√πng
  
  userId         Int
  user           User            @relation(fields: [userId], references: [id])
  
  addressId      Int
  address        UserAddress     @relation(fields: [addressId], references: [id])

  orderDetails   OrderDetail[]
  statusLogs     OrderStatusLog[]
  payment        Payment?
  shipment       Shipment?
  voucherUsages  VoucherUsage[]

  @@map("Orders")
}

// ---------------------------------------------------------
// ‚≠ê 1Ô∏è‚É£5Ô∏è‚É£ ORDER DETAILS (Chi ti·∫øt ƒë∆°n - L∆∞u gi√° l√∫c mua)
// ---------------------------------------------------------
model OrderDetail {
  id        Int            @id @default(autoincrement())
  quantity  Int
  unitPrice Decimal        @db.Decimal(10, 2) // Gi√° t·∫°i th·ªùi ƒëi·ªÉm ƒë·∫∑t h√†ng (QUAN TR·ªåNG)
  
  orderId   Int
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@map("OrderDetails")
}

model OrderStatusLog {
  id        Int         @id @default(autoincrement())
  oldStatus OrderStatus
  newStatus OrderStatus
  changedAt DateTime    @default(now())
  
  orderId   Int
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("OrderStatusLogs")
}

// ---------------------------------------------------------
// 1Ô∏è‚É£7Ô∏è‚É£ & 1Ô∏è‚É£8Ô∏è‚É£ VOUCHERS
// ---------------------------------------------------------
enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model Voucher {
  id            Int            @id @default(autoincrement())
  code          String         @unique
  discountType  DiscountType
  discountValue Decimal        @db.Decimal(10, 2)
  minOrderValue Decimal?       @db.Decimal(10, 2)
  startDate     DateTime
  endDate       DateTime
  usageLimit    Int            @default(100)
  status        Boolean        @default(true)
  
  usages        VoucherUsage[]

  @@map("Vouchers")
}

model VoucherUsage {
  id        Int      @id @default(autoincrement())
  usedAt    DateTime @default(now())
  
  voucherId Int
  voucher   Voucher  @relation(fields: [voucherId], references: [id])
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  orderId   Int
  order     Order    @relation(fields: [orderId], references: [id])

  @@map("VoucherUsages")
}

// ---------------------------------------------------------
// 1Ô∏è‚É£9Ô∏è‚É£ PAYMENTS
// ---------------------------------------------------------
enum PaymentMethod {
  COD
  BANK_TRANSFER
  CREDIT_CARD
  E_WALLET
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model Payment {
  id              Int           @id @default(autoincrement())
  amount          Decimal       @db.Decimal(12, 2)
  paymentMethod   PaymentMethod
  status          PaymentStatus @default(PENDING)
  transactionCode String?       // M√£ giao d·ªãch ng√¢n h√†ng/VNPAY
  paidAt          DateTime?
  
  orderId         Int           @unique
  order           Order         @relation(fields: [orderId], references: [id])

  @@map("Payments")
}

// ---------------------------------------------------------
// 2Ô∏è‚É£0Ô∏è‚É£ SHIPMENTS
// ---------------------------------------------------------
model Shipment {
  id               Int       @id @default(autoincrement())
  shippingProvider String    // GHN, GHTK, ViettelPost
  trackingCode     String?   // M√£ v·∫≠n ƒë∆°n
  shippingFee      Decimal   @db.Decimal(10, 2)
  status           String    // Tr·∫°ng th√°i t·ª´ b√™n v·∫≠n chuy·ªÉn
  shippedAt        DateTime?
  deliveredAt      DateTime?
  
  orderId          Int       @unique
  order            Order     @relation(fields: [orderId], references: [id])

  @@map("Shipments")
}

// ---------------------------------------------------------
// 2Ô∏è‚É£1Ô∏è‚É£ & 2Ô∏è‚É£2Ô∏è‚É£ REVIEWS & WISHLIST
// ---------------------------------------------------------
model Review {
  id        Int            @id @default(autoincrement())
  rating    Int            // 1-5 sao
  comment   String?        @db.Text
  createdAt DateTime       @default(now())
  
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  
  userId    Int
  user      User           @relation(fields: [userId], references: [id])

  @@map("Reviews")
}

model Wishlist {
  id        Int            @id @default(autoincrement())
  createdAt DateTime       @default(now())
  
  userId    Int
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@map("Wishlists")
}